<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>NEXUS ID</title>
    <style>
        .main-content {
            overflow: auto;
            background-color: transparent;
            padding: 2% 8%;
            background-color: rgb(244, 245, 246);
            gap: 10px;
            justify-content: flex-start;
            align-items: center;
            border: none;
        }
        .main-frame {
            position: relative;
            gap: 0;
        }
        .ctrl.left {
            width: 100%;
            max-height: 60px;
            padding: 0;
        }
        .notifPlate {
            width: 60%;
            height: auto;
            border-radius: 15px;
            padding: 16px;
            box-shadow: 0 6px 8px rgb(210, 209, 209);
            background-color: white;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            flex-direction: row;
            gap: 5px;
        }
        .nIcon, .nContent {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .nIcon {
            width: 10%;
            height: 100%;
            display: flex;
            align-items: flex-start;
            justify-content: flex-start;
            flex-direction: column;
        }
        .nIcon i {
            height: 40px;
            width: 40px;
            font-size: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
            color: green;
            padding-left: 5px;
            border: 1px solid green;
        }

        .nContent {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 5px;
            width: 88%;
        }
        .nContent p {
            font-size: 10px;
        }
        .nPTitle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-direction: row;
            width: 100%;
        }
        .nPDesc, .nPDesc2 {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            flex-direction: column;
            width: 100%;
            font-size: 10px;
        }
        .nPDesc2 {
            background-color: rgb(244, 246, 245);
        }
        .nPAction {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-direction: row;
            width: 100%;
            gap: 8px;
            color: gray;
        }
        h3 {
            font-weight: 500;
            font-size: 12px;
            text-align: left;
            width: 58%;
            height: auto;
        }
        button:disabled:hover {
            pointer-events: none;
            transform: none;
        }
        .faded {
            opacity: 0.8;
            background-color: transparent;
            box-shadow: none;
            border: none;
        }
        .faded i {
            color: gray;
            border: 1px solid gray;
            opacity: 0.5;
        }
        .ctrl.mid .sbtn, .ctrl.mid .pbtn {
            border-radius: 0;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            border: none;
            color: black;
            max-width: 250px;
            width: 250px;
            font-size: 16px;
            cursor: pointer;
        }
        .ctrl.mid .sbtn {
            background-color: rgb(244, 245, 246);
            color: green;
            font-weight: 600;
        }
        .ctrl.mid .sbtn:hover, .ctrl.mid .pbtn:hover {
            transform: none;
            background-color: rgb(244, 245, 246);
            opacity: 0.9;
            color: darkgreen;
        }
        .notifPlate p1 {
            font-size: 14px;
        }
        .notifPlate p2 {
            font-size: 12px;
        }
        .notifPlate p {
            font-size: 8px;
        }
        .notifPlate p3 {
            font-size: 10px;
        }
        .ctrl.right button, .ctrl.right .sbtn {
            font-size: 10px;
        }
        form a:hover, form button:hover {
            transform: scale(1.08);
            transition: all 0.8s ease; /* Smooth transition */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="userOption" style="display: none;">
            <a href="/admin/user">Profile <i class="fa-solid fa-user"></i></a><hr>
            <a href="/admin/welcome">Logout <i class="fa-solid fa-arrow-right-from-bracket"></i></a>
        </div>
        <div class="notif-nav" style="display: none;">
            <iframe class="notif-frame" src="/admin/notif" width="100%" height="100%" frameborder="0"></iframe>
        </div>
        <div class="info-nav" style="display: none;">
            <iframe class="info-frame" src="/admin/hotline" width="100%" height="100%" frameborder="0"></iframe>
        </div>

        <div class="side-frame">
            <div class="head-nav" style="margin-top: 0;">
                <div class="nav" style="justify-content: flex-start; width: 100%;">               
                    <div class="pnav" style="align-items: flex-start;">
                    <a href="#" id="userIcon" class="userIcon" style=" border: 1px solid gray; border-radius: 50%; box-shadow: none;">
                        <img src="<%= employeeData.userPhoto ? employeeData.userPhoto : '/images/profileX.jpg' %>" onerror="this.onerror=null; this.src='/images/profileX.jpg';" alt="Profile Picture">
                    </a>
                    </div>
                    <div class="snav">
                        <% if (employeeData) { %>
                            <% if (employeeData.role === 'Admin') { %>
                                <p2>Welcome Admin <br>
                                    <fh style="font-size: 20px;"><%= employeeData.firstName %></fh>
                                </p2>
                            <% } else if (employeeData.role === 'HR') { %>
                                <p2>Welcome HR <br>
                                    <fh style="font-size: 20px;"><%= employeeData.firstName %></fh>
                                </p2>
                            <% } else { %>
                                <p2>Welcome <br>
                                    <fh style="font-size: 20px;"><%= employeeData.firstName %></fh>
                                </p2>
                            <% } %>
                        <% } else { %>
                            <p2>Welcome Guest!</p2>
                        <% } %>
                    </div>
                </div>
            </div>
            <br>
            <div class="side-nav">
                <% if (user.role === 'HR' || user.role === 'Admin') { %>
                    <a href="/admin/notif" class="active" style="position: relative; border: 0.5px solid lightgray;">
                    <i class="fas fa-bell"></i>
                    <% if (pendingCount > 0) { %>
                        <span id="badge" class="badge"><%= pendingCount %></span>
                    <% } %>
                    Notification
                </a>
                    <% } %>
                    <a href="/admin/ann" class="ann" style="position: relative; border: 0.5px solid lightgray;">
                        <i class="fas fa-circle-exclamation"></i> Announcements
                    </a>
                    <hr>
                    <% if (user.role === 'HR' || user.role === 'Admin') { %>
                    <a href="/admin/das" class="das"><i class="bi bi-bar-chart-fill"></i> Dashboard</a>
                    <a href="/admin/emp" class="emp"><i class="fas fa-user-tie"></i> Employees</a>
                    <% } %>
                    <a href="/admin/dig" class="dig"><i class="fas fa-address-card"></i> My Digital ID</a>
                    <a href="/admin/dir" class="dir"><i class="fa-solid fa-address-book"></i> Directory</a>
                    <a href="/admin/frm" class="frm"><i class="fas fa-file-alt"></i> Forms</a>
            </div>

            <div class="logo-nav">
                <img src="/images/logo.png" alt="NEXUS ID Logo">
                <p1>NEXUS ID</p1>
            </div>
        </div>

        <div class="main-frame">
            <div class="sub">
                <div class="ctrl left">
                    <ph>Notification Center</ph>
                </div>
                <div class="ctrl right">
                    <input type="text" id="univ" placeholder="Search a request ... " oninput="notifPlate()">
                </div>
            </div>


            <% if (user.role === 'HR') { %>
                <div class="main-content">
                    <% 
                    // Function to format the date as needed
                    const formatDate = (date) => {
                        const options = {
                            month: 'short',     // 'Jan', 'Feb', etc.
                            day: 'numeric',     // '1', '2', '3', etc.
                            year: 'numeric',    // '2024'
                            hour: '2-digit',    // '08'
                            minute: '2-digit',  // '17'
                            hour12: true        // Use 12-hour time format with AM/PM
                        };

                        // Get the current date and compare it with the input date
                        const now = new Date();
                        const inputDate = new Date(date);
                        
                        // Check if the date is today
                        if (inputDate.toDateString() === now.toDateString()) {
                            return "Today, " + inputDate.toLocaleString('en-US', options).replace(",", "");
                        }

                        // Check if the date is yesterday
                        now.setDate(now.getDate() - 1); // Set 'now' to yesterday
                        if (inputDate.toDateString() === now.toDateString()) {
                            return "Yesterday, " + inputDate.toLocaleString('en-US', options).replace(",", "");
                        }

                        // Default behavior if it's neither today nor yesterday
                        return inputDate.toLocaleString('en-US', { weekday: 'long', ...options }).replace(",", "");
                    };

            
                    // Loop through the combined notifications array
                    notifications.forEach(notification => {
                        // Check if the notification is from changestatus or users
                        if (notification.hasOwnProperty('created_at')) {
                            // changestatus notification
                    %>
                        <div  id="status-<%= notification.id %>" class="notifPlate <%= (notification.status === 'Decline' || notification.status === 'Success') ? 'faded' : '' %>">
                            <div class="nIcon" style="align-items: flex-start;">
                                <i class="fas fa-user-pen"></i>
                            </div>
                            <div class="nContent">
                                <div class="nPTitle">
                                    <p1><%= notification.requestBy %></p1>
                                    <p3><%= formatDate(new Date(notification.created_at)) %></p3>
                                </div>
                                <div class="nPDesc">
                                    Is requesting to update information!
                                </div>
                                <div class="nPDesc2" style="display: none; padding: 20px; border-radius: 14px;">
                                    <p style="font-size: small; line-height: 2em;">
                                        <% if (notification.firstName) { %>
                                            First Name: <%= notification.firstName %><br>
                                        <% } %>
                                        <% if (notification.middleName) { %>
                                            Middle Name: <%= notification.middleName %><br>
                                        <% } %>
                                        <% if (notification.lastName) { %>
                                            Last Name: <%= notification.lastName %><br>
                                        <% } %>
                                        <% if (notification.extName) { %>
                                            Ext Name: <%= notification.extName %><br>
                                        <% } %>
                                        <% if (notification.userId) { %>
                                            Employee Id: <%= notification.userId %><br>
                                        <% } %>
                                        <% if (notification.position) { %>
                                            Position: <%= notification.position %><br>
                                        <% } %>
                                        <% if (notification.type) { %>
                                            Employment Type: <%= notification.type %><br>
                                        <% } %>
                                        <% if (notification.office) { %>
                                            Designated Office: <%= notification.office %><br>
                                        <% } %>
                                        <% if (notification.remarks) { %>
                                            Reason/Remarks: <%= notification.remarks %><br>
                                        <% } %>
                                    </p>
                                </div>
                                <div class="nPAction">
                                    <span id="status" 
                                    <% if (notification.status === 'Success') { %>
                                        style="color: green; font-weight: 400;" 
                                    <% } else if (notification.status === 'Decline') { %>
                                        style="color: red;" 
                                    <% } else { %>
                                        style="color: #44624a;" 
                                    <% } %>
                                    >
                                        Status: <%= notification.status %>
                                         >> <a class="show" href="#" style="text-decoration: none; color: black;">show details</a>
                                    </span>
                                    <div class="ctrl right">
                                        <form action="/admin/update-statushr/<%= notification.id %>?_method=PATCH" method="POST">
                                            <button type="submit" class="pbtn"
                                                <% if (notification.status === 'Decline' || notification.status === 'Success') { %>
                                                    disabled
                                                    style="background-color: white; color: black; opacity: 0.5; display: none;" 
                                                <% } %>>
                                                Decline
                                            </button>
                                        </form>
                                        <br>
                                        <form action="" method="">
                                            <a class="sbtn" href="editEmpMN/<%= notification.id %>"
                                            <% if (notification.status === 'Decline' || notification.status === 'Success') { %>
                                                style="display: none;" 
                                            <% } %>>Proceed</a>
                                        </form>
                                        <% if (notification.status === 'Decline' || notification.status === 'Success') { %>
                                            <form action="/admin/restorehr/<%= notification.id %>?_method=PATCH" method="POST">
                                                <button type="submit" class="pbtn" style="cursor: pointer;">
                                                    Re-Update
                                                </button>
                                            </form>
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <% } else if (notification.hasOwnProperty('createdAt')) {
                        // users notification
                    %>
                        <div  id="status-<%= notification.id %>" class="notifPlate <%= (notification.status === 'Decline' || notification.status === 'Success') ? 'faded' : '' %>">
                            <div class="nIcon">
                                <i class="fa fa-user-plus"></i>
                            </div>
                            <div class="nContent">
                                <div class="nPTitle">
                                    <p1><%= notification.firstName %> <%= notification.lastName %></p1>
                                    <p3><%= formatDate(new Date(notification.createdAt)) %></p3>
                                </div>
                                <div class="nPDesc">
                                    New user registration! Verify Details
                                </div>
                                <div class="nPDesc2" style="display: none; padding: 20px; border-radius: 14px;">
                                    <p style="font-size: small; line-height: 2em;">
                                        First Name: <%= notification.firstName %><br>
                                        <% if (notification.middleName) { %>
                                            Middle Name: <%= notification.middleName %><br>
                                        <% } %>
                                        Last Name: <%= notification.lastName %><br>
                                        <% if (notification.extName) { %>
                                            Extension Name: <%= notification.extName %><br>
                                        <% } %>
                                        Gender: <%= notification.gender %><br>
                                        Email: <%= notification.email %><br>
                                        Phone: <%= notification.phone %><br>
                                        Position: <%= notification.position %><br>
                                        Type: <%= notification.type %><br>
                                        Office: <%= notification.office %><br>
                                        Birthday: <%= notification.birthday %><br>
                                    </p>
                                </div>
                                <div class="nPAction">
                                    <span id="status" 
                                    <% if (notification.status === 'Success') { %>
                                        style="color: green; font-weight: 400;" 
                                    <% } else if (notification.status === 'Decline') { %>
                                        style="color: red;" 
                                    <% } else { %>
                                        style="color: #44624a;" 
                                    <% } %>
                                    >
                                        Status: <%= notification.status %>
                                         >> <a class="show" href="#" style="text-decoration: none; color: black;">show details</a>
                                    </span>
                                    <div class="ctrl right">
                                        <form action="/admin/update-status3/<%= notification.id %>?_method=PATCH" method="POST">
                                            <button type="submit" class="pbtn"
                                                <% if (notification.status === 'Decline' || notification.status === 'Success') { %>
                                                    disabled
                                                    style="background-color: white; color: black; opacity: 0.5; display: none;" 
                                                <% } %>>
                                                Decline
                                            </button>
                                        </form>
                                        <br>
                                        <form action="" method="">
                                            <a class="sbtn" href="/admin/regAcc/<%= notification.id %>"
                                            <% if (notification.status === 'Decline' || notification.status === 'Success') { %>
                                                style="display: none;" 
                                            <% } %>>Proceed</a>
                                        </form>
                                        <% if (notification.status === 'Decline') { %>
                                            <form action="/admin/restore3/<%= notification.id %>?_method=PATCH" method="POST">
                                                <button type="submit" class="pbtn" style="cursor: pointer;">
                                                    Restore
                                                </button>
                                            </form>
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <% } %>
                    <% }); %>
                </div>
            <% } %>
            
                
            <% if (user.role === 'Admin') { %>
    <div class="main-content">
        <% 
        // Function to format the date as needed
        const formatDate = (date) => {
            const options = {
                month: 'short',     // 'Jan', 'Feb', etc.
                day: 'numeric',     // '1', '2', '3', etc.
                year: 'numeric',    // '2024'
                hour: '2-digit',    // '08'
                minute: '2-digit',  // '17'
                hour12: true        // Use 12-hour time format with AM/PM
            };

            const now = new Date();
            const inputDate = new Date(date);
            
            // Check if the date is today
            if (inputDate.toDateString() === now.toDateString()) {
                return "Today, " + inputDate.toLocaleString('en-US', options).replace(",", "");
            }

            // Check if the date is yesterday
            now.setDate(now.getDate() - 1); // Set 'now' to yesterday
            if (inputDate.toDateString() === now.toDateString()) {
                return "Yesterday, " + inputDate.toLocaleString('en-US', options).replace(",", "");
            }

            // Default: Use the full weekday name if it's neither today nor yesterday
            return inputDate.toLocaleString('en-US', { weekday: 'long', ...options }).replace(",", "");
        };

        // Sort notifications by 'createAt' in descending order (newest first)
        idPrintNotifications.sort((a, b) => new Date(b.createAt) - new Date(a.createAt));

        %>

        <% idPrintNotifications.forEach(status => { %>
            <div  id="status-<%= status.id %>" class="notifPlate <%= (status.status === 'Decline' || status.status === 'Success') ? 'faded' : '' %>">
                <div class="nIcon" style="align-items: flex-start; height: 100%;">
                    <i class="fa-solid fa-print" style="padding-left: 0;"></i>
                </div>
                <div class="nContent">
                    <div class="nPTitle">
                        <p1><%= status.userName %></p1>
                        <p3><%= formatDate(new Date(status.createAt)) %></p3>
                    </div>
                    <div class="nPDesc">
                        Is requesting to Print Physical ID
                    </div>
                    <div class="nPDesc2" style="display: none; padding: 20px; border-radius: 14px;">
                        <p style="font-size: small; line-height: 2em;">
                            <% if (status.idType) { %>
                                ID Type: <%= status.idType %>
                            <% } %>
                            <% if (status.remarks) { %>
                                <br>Reason/Remarks: <%= status.remarks %><br>
                            <% } %>
                        </p>
                    </div>
                    <div class="nPAction">
                        <span id="status" 
                        <% if (status.status === 'Success') { %>
                          style="color: green; font-weight: 400;" 
                        <% } else if (status.status === 'Decline') { %>
                          style="color: red;" 
                        <% } else { %>
                          style="color: #44624a;" 
                        <% } %>
                      >
                        Status: <%= status.status %>
                            >> <a class="show" href="#" style="text-decoration: none; color: black;">show details</a>
                        </span>
                        <div class="ctrl right">
                            <form action="" method="">
                                <a class="pbtn" href="idUserPrint/<%= status.userId %>"
                                <% if (status.status === 'Decline' || status.status === 'Success') { %>
                                    style="display: none;" 
                                <% } %>><i class="fa-solid fa-print" style="font-size: inherit;"></i>Print ID</a>
                            </form>
                            <form action="/admin/update-status/<%= status.id %>?_method=PATCH" method="POST">
                                <button type="submit" class="pbtn"
                                    <% if (status.status === 'Decline' || status.status === 'Success') { %>
                                        disabled
                                        style="display: none;" 
                                    <% } %>>
                                    <i class="fas fa-circle-xmark" style="color: inherit; font-size: inherit;"></i>
                                    Decline
                                </button>
                            </form>
                            <br>
                            <% if (status.status === 'Decline' || status.status === 'Success') { %>
                                <form action="/admin/restore/<%= status.id %>?_method=PATCH" method="POST">
                                    <button type="submit" class="pbtn" style="cursor: pointer;">
                                        Restore
                                    </button>
                                </form>
                            <% } %>
                            
                            <form action="/admin/update-statusAdmin/<%= status.id %>?_method=PATCH" method="POST">
                                <button type="submit" class="sbtn"
                                    <% if (status.status === 'Success' || status.status === 'Decline') { %>
                                        disabled
                                        style="display: none;" 
                                    <% } %>>
                                    <i class="fas fa-circle-check" style="color: inherit; font-size: inherit;"></i>Success
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        <% }); %>
    </div>
<% } %>



        </div>
    </div>
    <script>
        document.querySelectorAll('.nPAction a.show').forEach((button) => {
            button.addEventListener('click', function(event) {
                event.preventDefault();
                const notifPlate = button.closest('.notifPlate');
                const details = notifPlate.querySelector('.nPDesc2');
                const showText = button.textContent.trim() === 'show details' ? 'hide details' : 'show details';
                
                details.style.display = (details.style.display === 'none' || details.style.display === '') ? 'flex' : 'none';
                button.textContent = showText;
            });
        });
    </script>
    

    <script>
        document.getElementById('userIcon').addEventListener('click', function(event) {
            event.preventDefault(); // Prevent default link behavior
            const userOption = document.querySelector('.userOption');
            const rect = this.getBoundingClientRect();
            const distanceBelow = 9;

            if (userOption.style.display === 'none' || userOption.style.display === '') {
                userOption.style.display = 'flex'; // Show the notif-nav
                userOption.style.left = '8px'; // Align to the right edge
                userOption.style.top = `${rect.bottom + distanceBelow}px`; // Position below the icon
                this.classList.add('user-icon-active'); // Add active class
            } else {
                userOption.style.display = 'none'; // Hide the notif-nav
                this.classList.remove('user-icon-active'); // Remove active class
            }
        });
        
        document.addEventListener('click', (event) => {
            const userOption = document.querySelector('.userOption');
            if (!event.target.closest('#userIcon') && !userOption.contains(event.target)) {
                userOption.style.display = 'none'; // Hide the info-nav
                document.getElementById('userIcon').classList.remove('user-icon-active'); // Remove active class
            }
        });
    </script>
    <script>
        function notifPlate() {
    // Get the search input value and convert it to lowercase for case-insensitive matching
    const searchQuery = document.getElementById('univ').value.toLowerCase();

    // Get all the .notifPlate divs
    const notifPlates = document.querySelectorAll('.notifPlate');

    // Loop through each .notifPlate and check if it matches the search query
    notifPlates.forEach(notifPlate => {
        // Get the text content of the current .notifPlate (you can choose to filter by specific elements, e.g., title, description)
        const notifContent = notifPlate.textContent.toLowerCase();

        // Check if the notifContent includes the search query
        if (notifContent.includes(searchQuery)) {
            // Show the notifPlate if it matches the search query
            notifPlate.style.display = 'flex';
        } else {
            // Hide the notifPlate if it doesn't match the search query
            notifPlate.style.display = 'none';
        }
    });
}
</script>

</body>
</html>
