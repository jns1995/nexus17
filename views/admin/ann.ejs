<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>NEXUS ID</title>
    <style>
        .main-content {
            overflow: auto;
            background-color: #d9dfda;
            padding: 1% 18% 1% 18%;
            gap: 25px;
            justify-content: flex-start;
            align-items: flex-start;
        }
        .main-frame {
            position: relative;
        }
        .row.btn {
            position: absolute;
            bottom: 1px;
            right: 15px;
            gap: 0;
        }
        .row.btn a, .row.btn button {
            padding: 5px 5px;
            color: white;
            text-align: center;
            border-radius: 20px;
            font-size: 8px;
            text-decoration: none;
            flex: 1 ;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: none;
            cursor: pointer;
        }
        .row.btn button {
            background-color: transparent;
        }
        .row.btn a:hover, .row.btn button:hover {
            background-color: #f8f8f8;
        }
        .row.btn a:hover i {
            color: #395830;
        }
        .row.btn a i {
            font-size: 10px;
        }

        .row.btn a:hover {
            transform: scale(1.02);
        }
        .row.btn .dbtn {
            background-color: orangered;
        }
        .row.btn .ebtn {
            background-color: transparent;
        }
        .row.btn .nbtn {
            background-color: #2e7d32;
        }
        .row.btn .cbtn {
            background-color: #888;
        }
        .sub.top {
            height: auto;
            width: 30%;
            padding: 20px 10px;
            position: absolute;
            top: 12%;
            right: 70px;
            align-items: flex-start;
            justify-content: flex-end;
            background-color: rgb(255, 255, 255);
            flex-direction: column;
            display: flex;
            box-shadow: 0 2px 6px rgb(161, 160, 160);
            border-radius: 18px;
        }
        .sub.bottom {
            height: 100%;
            width: 100%;
            padding: 10px 280px;
            position: absolute;
            top: 0;
            align-items: flex-start;
            justify-content: center;
            background-color: #ecefec;
            flex-direction: column;
            flex: none;
            box-shadow: 0 2px 6px rgb(161, 160, 160);
            border-radius: 18px;
            z-index: 300;
        }
        .sub.mid {
            height: 100%;
            width: 65%;
            padding: 10px 50px;
            position: absolute;
            top: 0;
            align-items: flex-start;
            justify-content: center;
            background-color: #ecefec;
            flex-direction: column;
            flex: none;
            box-shadow: 0 2px 6px rgb(161, 160, 160);
            border-radius: 18px;
            z-index: 100;
        }
        .main-frame {
            position: relative;
        }
        .ctrl.left {
            width: 100%;
            max-height: 60px;
            padding: 0;
        }
        .sub input, .sub textarea {
            width: 100%;
            flex: 1;
        }
        label {
            padding-left: 5px;
        }
        form.AnnForm {
            width: 100%;
            gap: 20px;
            padding: 0;
            display: block;
        }
        #dbtn i, #ebtn i {
            font-size: 10px;
            margin: 0;
            color: inherit;
        }
        #dbtn, #ebtn {
            width: auto;
            color: inherit;
            padding: 12px;
            font-size: 12px;
            font-weight: normal;
            color: white;
        }
        #dbtn {
            background-color: rgb(244, 246, 245);
            color: black;
        }
        #ebtn {
            background-color: #2e7d32;
        }
        .annCov {
            width: 95%;
            height: 350px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 10px;
        }
        .annCov img {
            width: auto;
            height: 100%;
            max-width: 100%;
            border-radius: 10px;
        }
        .ctrl.right a:hover, .ctrl button:hover, .ctrl.left a:hover {
            transform: scale(1.08);
            transition: all 0.8s ease; /* Smooth transition */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="userOption" style="display: none;">
            <a href="/admin/user">Profile <i class="fa-solid fa-user"></i></a><hr>
            <a href="/admin/welcome">Logout <i class="fa-solid fa-arrow-right-from-bracket"></i></a>
        </div>
        <div class="notif-nav" style="display: none;">
            <iframe class="notif-frame" src="/admin/notif" width="100%" height="100%" frameborder="0"></iframe>
        </div>
        <div class="info-nav" style="display: none;">
            <iframe class="info-frame" src="/admin/hotline" width="100%" height="100%" frameborder="0"></iframe>
        </div>

        <div class="side-frame">
            <div class="head-nav" style="margin-top: 0;">
                <div class="nav" style="justify-content: flex-start; width: 100%;">               
                    <div class="pnav" style="align-items: flex-start;">
                    <a href="#" id="userIcon" class="userIcon" style=" border: 1px solid gray; border-radius: 50%; box-shadow: none;">
                        <img src="<%= employeeData.userPhoto ? employeeData.userPhoto : '/images/profileX.jpg' %>" onerror="this.onerror=null; this.src='/images/profileX.jpg';" alt="Profile Picture">
                    </a>
                    </div>
                    <div class="snav">
                        <% if (employeeData) { %>
                            <% if (employeeData.role === 'Admin') { %>
                                <p2>Welcome Admin <br>
                                    <fh style="font-size: 20px;"><%= employeeData.firstName %></fh>
                                </p2>
                            <% } else if (employeeData.role === 'HR') { %>
                                <p2>Welcome HR <br>
                                    <fh style="font-size: 20px;"><%= employeeData.firstName %></fh>
                                </p2>
                            <% } else { %>
                                <p2>Welcome <br>
                                    <fh style="font-size: 20px;"><%= employeeData.firstName %></fh>
                                </p2>
                            <% } %>
                        <% } else { %>
                            <p2>Welcome Guest!</p2>
                        <% } %>
                    </div>
                </div>
            </div>
            <br>
            <div class="side-nav">
                <% if (user.role === 'HR' || user.role === 'Admin') { %>
                    <a href="/admin/notif" class="notif" style="position: relative; border: 0.5px solid lightgray;">
                    <i class="fas fa-bell"></i>
                    <% if (pendingCount > 0) { %>
                        <span id="badge" class="badge"><%= pendingCount %></span>
                    <% } %>
                    Notification
                </a>
                <% } %>
                    <a href="/admin/ann" class="active" style="position: relative; border: 0.5px solid lightgray;">
                        <i class="fas fa-circle-exclamation"></i> Announcements
                    </a>
                    <hr>
                    <% if (user.role === 'HR' || user.role === 'Admin') { %>
                    <a href="/admin/das" class="das"><i class="bi bi-bar-chart-fill"></i> Dashboard</a>
                    <a href="/admin/emp" class="emp"><i class="fas fa-user-tie"></i> Employees</a>
                    <% } %>
                    <a href="/admin/dig" class="dig"><i class="fas fa-address-card"></i> My Digital ID</a>
                    <a href="/admin/dir" class="dir"><i class="fa-solid fa-address-book"></i> Directory</a>
                    <a href="/admin/frm" class="frm"><i class="fas fa-file-alt"></i> Forms</a>
            </div>
            

            <div class="logo-nav">
                <img src="/images/logo.png" alt="NEXUS ID Logo">
                <p1>NEXUS ID</p1>
            </div>
        </div>

        <div class="main-frame">
            <div class="sub">
                <div class="ctrl left">
                    <ph>Announcements</ph>
                </div>
                <div class="ctrl right">
                    <input type="text" id="univ" placeholder="e.g. Training, Sale, Holiday">
                    &nbsp; Sort
                    <input type="date" id="startDate" placeholder="Start Date" style="max-width: 140px;">
                    to: <input type="date" id="endDate" placeholder="End Date" style="max-width: 140px;">
                    <a href="" class="sbtn" style="background-color: transparent; color: black">
                        <i style="color: black" class="fa-solid fa-arrows-rotate"></i>
                    </a>
                    <% if (user.role === 'HR' || user.role === 'Admin') { %>
                        | <a href="#" id="newAnnIcon" class="sbtn"><i class="bi bi-plus"></i>Post New</a>
                    <% } %>
                    
                </div>
            </div>
            
            <div class="sub bottom" style="display: none">
                <div class="row btn" style="top: 2px; bottom:auto;">
                    <a href="#" class="xIcon" id="xIcon">
                        <i style="color: black; font-size: 24px;" class="fa-solid fa-xmark"></i>
                    </a>
                </div>
                <fh>Share your News!</fh>
                <br>
                <form class="AnnForm" id="announcementForm" method="POST" action="/admin/createAnn"  enctype="multipart/form-data">
                    <div class="ctrl left">
                        <label for="xtitle">Title</label>
                        <input type="text" id="xtitle" name="title" placeholder="e.g. New Implementation, Schedule, Notice" required>
                    </div>
                    <br>
                    <div class="ctrl left">
                        <label for="annFrom">From</label>
                        <input type="text" id="annFrom" name="annFrom" placeholder="Issued by: e.g. The City Mayor" required>
                        <label for="annFrom">To</label>
                        <input type="text" id="annto" name="annto" placeholder="Addressed to: e.g. To All Employees" required>
                    </div>
                    <br>
                    <div class="ctrl left" style="flex-direction: column; align-items: flex-start; max-height: 300px;">
                        <label for="txtDesc">Description</label>
                        <div style="max-height: 700px; height: auto;">
                            <textarea rows="16" cols="150" placeholder="Indicate the full details of your announcement here ..." id="txtDesc" name="description" required><%= announcement.description %></textarea>
                        </div>
                    </div>
                    <br>
                    <div class="ctrl left">
                        Upload Photo <input type="file" name="coverPhoto" style="background-color: white;">
                    </div>
                    <br>
                    <br>
                    <div class="ctrl left" style="justify-content: flex-end;">
                        <button type="reset" class="pbtn">
                            <i style="color: black" class="fa-solid fa-arrows-rotate"></i>
                            CLEAR
                        </button>
                        <button type="submit" class="sbtn">
                            <i class="fa-solid fa-paper-plane"></i>
                            POST NOW
                        </button>
                    </div>
                </form>
            </div>
            

            <div class="main-content">
                

                <% announcement.forEach((ann, index) => { %>
                    <div class="annCard" data-index="<%= index %>">
                        <div class="annContent">
                            <% if (user.role === 'HR' || user.role === 'Admin') { %>
                            <div class="row btn" style="gap: 10px;">
                                <a href="/admin/editAnn/<%= ann.id %>" class="editAnn" id="ebtn">
                                    <i class="fa-regular fa-pen-to-square"></i> MODIFY
                                </a>
                                <form action="/admin/deleteAnn/<%= ann.id %>?_method=DELETE" method="POST" style="display:inline;"  onsubmit="return confirmDelete()">
                                    <button type="submit" class="deleteAnn" id="dbtn">
                                        <i class="fa-solid fa-trash-can"></i> DELETE
                                    </button>
                                </form>
                            </div>
                            <% } %>
                            <ph class="annTitle"><%= ann.title %></ph>
                            <p class="fromto">To: <%= ann.annto %> | From: <%= ann.annFrom %></p> 
                            <br>
                            <hr>
                            <p class="annDescription" id="annDescription">
                                <% if (ann.description) { %>
                                    <%- ann.description.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>') %>
                                <% } else { %>
                                    <span>No description available</span>
                                <% } %>
                            </p>
                        </div>
                        <div class="annCov" <% if (!ann.coverPhoto) { %> style="display:none;" <% } %>>
                            <img src="<%= ann.coverPhoto || '/images/bg1.jpg' %>" alt="Cover Photo">
                        </div>
                        
                        <p class="annDate">
                            <span class="myDate"><%= ann.createdAt %></span> &bull;
                            <% 
                                const date = new Date(ann.createdAt);
                                let hours = date.getHours();
                                const minutes = date.getMinutes();
                                const ampm = hours >= 12 ? 'PM' : 'AM';
                                hours = hours % 12; // Convert to 12-hour format
                                hours = hours ? hours : 12; // The hour '0' should be '12'
                                const formattedTime = 
                                    hours.toString().padStart(2, '0') + ':' + 
                                    minutes.toString().padStart(2, '0') + ' ' + ampm;
                            %>
                            <%= formattedTime %> | Posted by &bull; <%= ann.role %>
                        </p>
                    </div>
                <% }) %>
        </div>
    </div>
    <script>
        function confirmDelete() {
            return confirm("Are you sure you want to delete this announcement?");
        }
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const annCards = document.querySelectorAll('.annCard');
            annCards.forEach(card => {
                const index = card.getAttribute('data-index');
                card.style.backgroundColor = index % 2 === 0 ? 'white' : 'white';
            });
        });
    </script>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const annCards = Array.from(document.querySelectorAll('.annCard'));
    
        // Function to format and label dates
        function formatDate(date) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
    
            if (date.toDateString() === today.toDateString()) {
                return `<span style="color: green; font-weight: 600;">NEW! TODAY -</span> ${date.toLocaleDateString('en-US', options)}`;
            } else if (date.toDateString() === yesterday.toDateString()) {
                return `<span style="color: green;">Yesterday -</span> ${date.toLocaleDateString('en-US', options)}`;
            }   
            return date.toLocaleDateString('en-US', options);
        }
    
        // Sort announcements by date
        function sortAnnouncements() {
            annCards.sort((a, b) => {
                const dateA = new Date(a.querySelector('.myDate').textContent);
                const dateB = new Date(b.querySelector('.myDate').textContent);
                return dateB - dateA; // Sort from latest to oldest
            });
    
            // Append sorted cards to the main content
            const mainContent = document.querySelector('.main-content');
            mainContent.innerHTML = ''; // Clear existing content
            annCards.forEach(card => {
                mainContent.appendChild(card);
            });
    
            // Format the dates for display
            annCards.forEach(card => {
                const annDateText = card.querySelector('.myDate').textContent;
                const annDate = new Date(annDateText);
                card.querySelector('.myDate').innerHTML = formatDate(annDate); // Use innerHTML to render HTML
            });
        }
    
        // Initial sort
        sortAnnouncements();
    
        // Filter function (with sorting)
        document.getElementById('univ').addEventListener('keyup', filterAnnouncements);
        document.getElementById('startDate').addEventListener('change', filterAnnouncements);
        document.getElementById('endDate').addEventListener('change', filterAnnouncements);
    
        function filterAnnouncements() {
            const filter = document.getElementById('univ').value.toLowerCase();
            const startDateInput = document.getElementById('startDate').value;
            const endDateInput = document.getElementById('endDate').value;
    
            const startDate = new Date(startDateInput);
            const endDate = new Date(endDateInput);
            
            annCards.forEach(card => {
                const title = card.querySelector('.annTitle').textContent.toLowerCase();
                const description = card.querySelector('.annDescription').textContent.toLowerCase();
                const annDateText = card.querySelector('.myDate').textContent;
                const annDate = new Date(annDateText.replace(/[^a-zA-Z0-9, ]/g, '')); // Clean the date text
    
                const matchesFilter = title.includes(filter) || description.includes(filter);
                const isWithinDateRange = (isNaN(startDate) || annDate >= startDate) && (isNaN(endDate) || annDate <= endDate);
    
                if (matchesFilter && isWithinDateRange) {
                    card.style.display = ""; // Show card
                } else {
                    card.style.display = "none"; // Hide card
                }
            });
        }
    });
    
</script> 
<script>
    // MAKE NEW ANNOUCEMENT //
const notificationDiv = document.querySelector('.sub.bottom');

document.getElementById('newAnnIcon').addEventListener('click', function(event) {
    event.preventDefault(); // Prevent default link behavior

    if (notificationDiv.style.display === 'none' || notificationDiv.style.display === '') {
        notificationDiv.style.display = 'flex'; // Show the div
        this.classList.add('user-icon-active'); // Add active class
    } else {
        notificationDiv.style.display = 'none'; // Hide the div
        this.classList.remove('user-icon-active'); // Remove active class
    }
});

// Close the div when clicking the close icon
document.getElementById('xIcon').addEventListener('click', function(event) {
    notificationDiv.style.display = 'none'; // Hide the div
    document.getElementById('newAnnIcon').classList.remove('user-icon-active'); // Remove active class
});

// Optional: Close the div when clicking outside
document.addEventListener('click', (event) => {
    if (!event.target.closest('#newAnnIcon') && !notificationDiv.contains(event.target)) {
        notificationDiv.style.display = 'none'; // Hide the div
        document.getElementById('newAnnIcon').classList.remove('user-icon-active'); // Remove active class
    }
});
</script>
<script>
    document.getElementById('userIcon').addEventListener('click', function(event) {
    event.preventDefault(); // Prevent default link behavior
    const userOption = document.querySelector('.userOption');
    const rect = this.getBoundingClientRect();
    const distanceBelow = 9;

    if (userOption.style.display === 'none' || userOption.style.display === '') {
        userOption.style.display = 'flex'; // Show the notif-nav
        userOption.style.left = '8px'; // Align to the right edge
        userOption.style.top = `${rect.bottom + distanceBelow}px`; // Position below the icon
        this.classList.add('user-icon-active'); // Add active class
    } else {
        userOption.style.display = 'none'; // Hide the notif-nav
        this.classList.remove('user-icon-active'); // Remove active class
    }
});

// Optional: Close the info-nav when clicking outside
document.addEventListener('click', (event) => {
    const userOption= document.querySelector('.userOption');
    if (!event.target.closest('#userIcon') && !userOption.contains(event.target)) {
        userOption.style.display = 'none'; // Hide the info-nav
        document.getElementById('userIcon').classList.remove('user-icon-active'); // Remove active class
    }
});
</script>
</body>
</html>
